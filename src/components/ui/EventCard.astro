---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import type { ImageMetadata } from "astro";
import * as m from "@/paraglide/messages";
import Card from "./Card.astro";

type Props = {
  event: CollectionEntry<"events">;
  index: number;
};

const { event, index } = Astro.props as Props;

// Dynamically import the image from assets
const images = import.meta.glob("/src/assets/images/**/*", { eager: true });
let optimizedImage: ImageMetadata | undefined;

if (event.data.images && event.data.images.length > 0) {
  // Convert CMS path (/images/events/filename.jpg) to asset path (events/filename.jpg)
  const relativeImagePath = event.data.images[0].replace(/^\/images\//, "");
  const imagePath = `/src/assets/images/${relativeImagePath}`;
  const imageModule = images[imagePath] as { default: ImageMetadata };
  optimizedImage = imageModule?.default;
}
---

<Card isUnderline={true}>
  <div
    class={`relative overflow-hidden rounded-[45px] border-0 h-full ${index % 2 === 0 ? "bg-gray" : "bg-green"}`}
  >
    <div class="relative h-64 w-full">
      {
        optimizedImage ? (
          <Image
            src={optimizedImage}
            alt={event.data.title}
            class="h-full w-full object-cover"
            width={600}
            height={300}
            loading="lazy"
          />
        ) : (
          <div
            class={`h-full w-full flex items-center justify-center ${index % 2 === 0 ? "bg-dark" : "bg-gray-200"}`}
          >
            <span class="text-gray-400">{m.events_noImage}</span>
          </div>
        )
      }
    </div>
    <div class="p-8 sm:p-[50px]">
      <div class="flex flex-col mb-6">
        <h3 class="text-2xl font-medium mb-4">
          <span class={`rounded-md px-2 text-white bg-dark`}>
            {event.data.title}
          </span>
        </h3>
        <p class="text-dark">{event.data.description}</p>
      </div>
      <a
        href={`/${Astro.currentLocale}/events/${event.slug.split("/")[1]}`}
        class="btn-primary inline-block mt-4"
      >
        {m.events_join}
      </a>
    </div>
  </div>
</Card>
